// Prisma schema for OpenRooms
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Room - Stateful Execution Environment
// ============================================================================

enum RoomStatus {
  IDLE
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

model Room {
  id            String     @id @default(uuid())
  name          String
  description   String?
  status        RoomStatus @default(IDLE)
  workflowId    String
  currentNodeId String?
  config        Json       @default("{}")
  metadata      Json       @default("{}")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  startedAt     DateTime?
  completedAt   DateTime?

  workflow      Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  agents        Agent[]
  executionLogs ExecutionLog[]
  memory        Memory?

  @@index([status])
  @@index([workflowId])
  @@index([createdAt])
  @@map("rooms")
}

// ============================================================================
// Workflow - Deterministic State Machine
// ============================================================================

enum WorkflowStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

model Workflow {
  id            String         @id @default(uuid())
  name          String
  description   String?
  version       Int            @default(1)
  status        WorkflowStatus @default(DRAFT)
  initialNodeId String
  metadata      Json           @default("{}")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  nodes         WorkflowNode[]
  rooms         Room[]
  executionLogs ExecutionLog[]

  @@index([status])
  @@map("workflows")
}

// ============================================================================
// WorkflowNode - State in FSM
// ============================================================================

enum NodeType {
  START
  AGENT_TASK
  TOOL_EXECUTION
  DECISION
  PARALLEL
  WAIT
  END
}

model WorkflowNode {
  id          String   @id @default(uuid())
  workflowId  String
  type        NodeType
  name        String
  description String?
  config      Json     @default("{}")
  transitions Json     @default("[]") // Array of NodeTransition
  retryPolicy Json?
  timeout     Int?     // milliseconds
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workflow      Workflow       @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  executionLogs ExecutionLog[]

  @@index([workflowId])
  @@index([type])
  @@map("workflow_nodes")
}

// ============================================================================
// Agent - AI Entity
// ============================================================================

model Agent {
  id          String   @id @default(uuid())
  roomId      String
  name        String
  description String?
  config      Json     @default("{}")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  room          Room           @relation(fields: [roomId], references: [id], onDelete: Cascade)
  executionLogs ExecutionLog[]

  @@index([roomId])
  @@map("agents")
}

// ============================================================================
// ExecutionLog - Observability
// ============================================================================

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

enum ExecutionEventType {
  ROOM_CREATED
  ROOM_STARTED
  ROOM_PAUSED
  ROOM_RESUMED
  ROOM_COMPLETED
  ROOM_FAILED
  NODE_ENTERED
  NODE_EXECUTED
  NODE_EXITED
  NODE_FAILED
  TOOL_INVOKED
  TOOL_COMPLETED
  TOOL_FAILED
  AGENT_INVOKED
  AGENT_RESPONSE
  AGENT_ERROR
  TRANSITION
  STATE_UPDATED
  MEMORY_UPDATED
}

model ExecutionLog {
  id         String               @id @default(uuid())
  roomId     String
  workflowId String
  nodeId     String?
  agentId    String?
  eventType  ExecutionEventType
  level      LogLevel
  message    String               @db.Text
  data       Json?
  error      Json?
  timestamp  DateTime             @default(now())
  duration   Int?                 // milliseconds
  metadata   Json                 @default("{}")

  room     Room          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  workflow Workflow      @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  node     WorkflowNode? @relation(fields: [nodeId], references: [id], onDelete: SetNull)
  agent    Agent?        @relation(fields: [agentId], references: [id], onDelete: SetNull)

  @@index([roomId, timestamp])
  @@index([workflowId])
  @@index([nodeId])
  @@index([eventType])
  @@index([level])
  @@map("execution_logs")
}

// ============================================================================
// Memory - Persistent Context
// ============================================================================

model Memory {
  id                  String   @id @default(uuid())
  roomId              String   @unique
  conversationHistory Json     @default("[]") // Array of ConversationMessage
  context             Json     @default("{}")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  room    Room          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  entries MemoryEntry[]

  @@map("memories")
}

enum MemoryType {
  SHORT_TERM
  LONG_TERM
  SEMANTIC
}

model MemoryEntry {
  id        String     @id @default(uuid())
  memoryId  String
  roomId    String
  type      MemoryType
  key       String
  value     Json
  embedding Float[]?   // For semantic memory (pgvector extension)
  ttl       Int?       // seconds
  metadata  Json       @default("{}")
  createdAt DateTime   @default(now())
  expiresAt DateTime?

  memory Memory @relation(fields: [memoryId], references: [id], onDelete: Cascade)

  @@index([memoryId])
  @@index([roomId])
  @@index([type])
  @@index([key])
  @@index([expiresAt])
  @@map("memory_entries")
}

// ============================================================================
// Tool - Extensible Plugin System
// ============================================================================

enum ToolCategory {
  COMPUTATION
  DATA_ACCESS
  EXTERNAL_API
  SYSTEM
  CUSTOM
}

model Tool {
  id          String       @id @default(uuid())
  name        String       @unique
  description String       @db.Text
  category    ToolCategory
  version     String
  parameters  Json         @default("[]") // Array of ToolParameter
  returnType  Json         @default("{}")
  requiresAuth Boolean     @default(false)
  rateLimit   Int?         // requests per minute
  timeout     Int?         // milliseconds
  metadata    Json         @default("{}")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([category])
  @@index([name])
  @@map("tools")
}
